<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Eggy AI Chatbot - Live Interactive Demo">
    <meta property="og:description" content="RAG-powered deal registration assistant with conversational UI">
    <meta property="og:image" content="https://bizalchemist.github.io/assets/images/AIDealRegistrationAssistant.png">
    <meta property="og:url" content="https://bizalchemist.github.io/dealregistrationpage.html">
    <title>Keysight Eggplant Partner Portal Deal Registration @bizalchemist Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/currency.js@2.0.4/dist/currency.min.js"></script>
  <style>
    /* --- ROOT & CORE STYLES --- */
    :root {
        --ks-red: #E90029;
        --ks-border: #e0e0e0;
        --ks-gray: #666;
        --ks-bg-light: #f9f9f9;
        --primary: #d8b4fe; 
        --primary-dark: #a855f7;
        --glass-border: rgba(255, 255, 255, 0.35);
    }

    body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #ffffff; color: #333; }
    .top-bar { background-color: var(--ks-red); height: 45px; display: flex; justify-content: flex-end; align-items: center; padding: 0 10%; }
    .icon-circle { background-color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 15px;}
    .icon-circle i { color: var(--ks-red); font-size: 14px; }
    
    /* --- NAVBAR & RESPONSIVE NAV FIX --- */
    .navbar { background-color: #ffffff; height: 90px; border-bottom: 1px solid var(--ks-border); display: flex; align-items: center; padding: 0 10%; justify-content: space-between; transition: all 0.3s ease; }
    .navbar-brand img { height: 52.5px; } 
    .nav-navbar { display: flex; list-style: none; margin: 0; padding: 0; gap: 40px; }
    .nav-navbar li { font-weight: 400; font-size: 14px; color: #333; cursor: pointer; text-transform: uppercase; letter-spacing: 0.8px; transition: color 0.2s ease; }
    .nav-navbar li.active { font-weight: 700; color: var(--ks-red); }
    .nav-navbar li:hover { color: var(--ks-red); }

    @media (max-width: 850px) {
        .navbar { height: auto; padding: 20px 5%; flex-direction: column; gap: 20px; text-align: center; }
        .nav-navbar { gap: 15px; flex-wrap: wrap; justify-content: center; }
        .nav-navbar li { font-size: 12px; letter-spacing: 0.5px; }
    }

    /* --- PAGE CONTENT & FORM --- */
    .page-content { padding: 40px 10%; max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 26px; margin-top: 30px; margin-bottom: 10px; font-weight: bold; }
    .instruction-text { font-size: 14px; color: #444; margin-bottom: 20px; line-height: 1.6; }
    
    .form-row { display: flex; gap: 30px; margin-bottom: 30px; }

    @media (max-width: 600px) { 
        .form-row { flex-direction: column; gap: 25px; margin-bottom: 25px; } 
        .page-content { padding: 20px 5%; }
    }

    .col-1 { flex: 1; position: relative; }
    .col-2 { flex: 2; position: relative; }
    .field-wrapper { position: relative; width: 100%; }
    input, select, textarea { width: 100%; padding: 22px 12px 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; background: white; box-sizing: border-box; outline: none; }
    label { position: absolute; left: 12px; top: 16px; color: var(--ks-gray); font-size: 14px; transition: all 0.2s ease-out; pointer-events: none; background: white; padding: 0 4px; }
    
    input:focus + label, input:not(:placeholder-shown) + label, 
    select:focus + label, select:not([data-value=""]) + label { top: -10px; left: 10px; font-size: 11px; color: var(--ks-red); font-weight: bold; }
    
    /* Textarea Specific Label Fix - No Overlap */
   /* SURGICAL FIX: Align label by adjusting the wrapper instead of margin */
    .field-wrapper textarea {
        margin-top: 0 !important; /* Remove the gap that was pushing the box away from the label */
    }

    .field-wrapper {
        margin-top: 10px; /* Move the whole unit down instead */
    }

    textarea + label { 
        top: -10px !important; /* This matches your other working inputs exactly */
        left: 10px !important; 
        font-size: 11px !important; 
        color: var(--ks-red) !important; 
        font-weight: bold !important; 
        background: white !important; 
        padding: 0 4px !important;
        z-index: 10 !important;
    }

    .prob-container { display: flex; border: 1px solid #ccc; background: white; border-radius: 4px; overflow: hidden; }
    .prob-container input { border: none; flex: 1; border-radius: 0; }
    .suffix { padding: 22px 10px 6px; background: #f4f4f4; border-left: 1px solid #ccc; color: #666; } 

/* 1. Only for the Currency Info Icon (i) */
    .required { 
        color: var(--ks-red); 
        position: absolute; 
        right: 12px; /* üõ°Ô∏è INSIDE the box: Perfectly safe for iPhone */
        top: 16px; 
        font-weight: bold; 
        z-index: 5;
    }

    /* 2. Standard Mobile Styling */
    @media (max-width: 600px) { 
        .page-content { 
            padding: 20px 20px !important; 
            box-sizing: border-box; 
        }
        .form-row { 
            flex-direction: column; 
            gap: 25px; 
            margin-bottom: 25px; 
        } 
        .btn-submit { 
            width: 100%; 
        }
    }

    #referral-upload-container { display: none; margin-bottom: 30px; padding: 40px; border: 2px dashed #ccc; background: #fafafa; text-align: center; transition: all 0.3s ease; opacity: 0; max-height: 0; overflow: hidden; border-radius: 12px; cursor: pointer; }
    #referral-upload-container.show { display: block; opacity: 1; max-height: 200px; }
    .btn-submit { background-color: var(--ks-red); color: white; padding: 15px 80px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; border-radius: 4px; }
    @media (max-width: 600px) { .btn-submit { width: 100%; } }

    /* --- FOOTER --- */
    footer { margin-top: 60px; padding: 40px 10%; border-top: 1px solid var(--ks-border); background-color: #f9f9f9; display: flex; justify-content: space-between; align-items: flex-start; line-height: 1.5; font-size: 14px; }
    @media (max-width: 768px) { 
        footer { flex-direction: column; gap: 30px; align-items: center; text-align: center; padding: 40px 5%; }
        .footer-right { text-align: center; }
        .social-links { justify-content: center; }
    }
    .footer-left p { margin: 2px 0; }
    .footer-right strong { display: block; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .social-links { display: flex; gap: 15px; }
    .social-links a { color: #333; font-size: 20px; transition: color 0.2s; }
    .social-links a:hover { color: var(--ks-red); }

    /* ============================================== */
    /* üÜï CHANGE #1: ENHANCED CHATBOT LAUNCHER CSS  */
    /* ============================================== */
    #chatbot-launcher {
        position: fixed; 
        bottom: 20px; 
        right: 20px; 
        width: 90px;  /* üÜï BIGGER! Was 75px */
        height: 90px; /* üÜï BIGGER! Was 75px */
        background: white; 
        border-radius: 50%; 
        box-shadow: 0 15px 40px rgba(168, 85, 247, 0.5); /* üÜï STRONGER SHADOW */
        cursor: pointer; 
        z-index: 9999; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        border: 3px solid var(--primary); /* üÜï THICKER BORDER */
        transition: all 0.3s ease;
        animation: launcher-breathe 3s ease-in-out infinite; /* üÜï BREATHING ANIMATION */
    }

    /* üÜï NEW: Breathing animation */
    @keyframes launcher-breathe {
        0%, 100% { 
            transform: scale(1); 
            box-shadow: 0 15px 40px rgba(168, 85, 247, 0.5);
        }
        50% { 
            transform: scale(1.1); 
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.8);
        }
    }

    /* üÜï NEW: "ASK EGGY" label below launcher */
    #chatbot-launcher::after {
        content: "ASK EGGY";
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: #a855f7;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
        font-family: 'DM Sans', sans-serif;
    }

/* --- MOBILE SPECIFIC FIXES --- */
    @media (max-width: 480px) { 
        #chatbot-launcher { 
            width: 65px;         /* Shrink from 75px to 65px */
            height: 65px; 
            bottom: 20px; 
            right: 15px;         /* Move closer to edge to save space */
        } 

        #chatbot-launcher img { 
            width: 38px;         /* Shrink image ONLY on mobile */
            height: 38px; 
        }

        #chatbot-launcher::after {
            font-size: 9px;
            padding: 3px 8px;
            bottom: -20px;
        }
    }

    /* --- DESKTOP SIZING (Keeps it big for Dan) --- */
    @media (min-width: 481px) {
        #chatbot-launcher img { 
            width: 52px; 
            height: 52px; 
        }
    }


    /* üÜï CHANGE #2: NEW TOOLTIP STYLES */
    /* ============================================== */
    #eggy-tooltip {
        position: fixed;
        bottom: 125px;
        right: 30px;
        background: linear-gradient(135deg, #a855f7, #d8b4fe);
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
        z-index: 9998;
        animation: pulse-tooltip 2s infinite;
        font-family: 'DM Sans', sans-serif;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    @keyframes pulse-tooltip {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 10px 40px rgba(168, 85, 247, 0.6); }
    }

    @media (max-width: 480px) {
        #eggy-tooltip {
            bottom: 110px;
            right: 20px;
            font-size: 12px;
            padding: 10px 16px;
        }
    }

/* üÜï CHANGE #3: NEW HELP BANNER STYLES - STABILIZED */
    /* ============================================== */
    .eggy-help-banner {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(216, 180, 254, 0.1)); 
        border-left: 4px solid #a855f7; 
        padding: 12px 16px; /* üì± Slightly tighter for mobile */
        border-radius: 8px; 
        margin-bottom: 30px;
        box-sizing: border-box; /* THE FIX: Keeps padding inside the width */
        width: 100%;           /* THE FIX: Ensures it stays within the parent */
    }

    .eggy-help-banner p {
        margin: 0; 
        display: flex; 
        align-items: center; 
        gap: 10px;
        flex-wrap: wrap; /* Vital: Allows the badge to drop down on tiny screens */
        font-size: 14px; /* Slightly smaller for standard mobile text */
    }

    .eggy-help-banner .eggy-badge {
        background: #a855f7; 
        color: white; 
        padding: 2px 8px; 
        border-radius: 12px; 
        font-size: 11px; /* Tighter for mobile */
        white-space: nowrap;
    }
    /* ============================================== */
    /* END OF NEW STYLES - REST IS UNCHANGED        */
    /* ============================================== */

    .notif-badge { position: absolute; top: 0; right: 0; background: var(--ks-red); color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; font-weight: bold; display: none; align-items: center; justify-content: center; border: 2px solid white; }

    @keyframes eggy-wave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); } }
    .wave-animate { animation: eggy-wave 0.5s ease-in-out 3; }

    #chatbot-window.chat-container {
        display: none; /* Keep this hidden by default so toggleChat() can work */
        position: fixed; bottom: 115px; right: 30px; width: 420px; height: 75vh;
        background: rgba(15, 23, 42, 0.7) !important; 
        backdrop-filter: blur(50px) saturate(210%); 
        -webkit-backdrop-filter: blur(50px) saturate(210%);
        border-radius: 32px;
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.3), 0 40px 80px rgba(0, 0, 0, 0.6); 
        border: 0.5px solid var(--glass-border);
        display: none; flex-direction: column; overflow: hidden; z-index: 10000;
    }

    /* EXACT INDEX00 RESPONSIVE LOGIC */
    @media (max-width: 480px) and (orientation: portrait) {
        .chat-container { 
            width: 82vw !important; 
            right: 15px !important; 
            height: 68vh !important; 
            bottom: 110px !important;
            border-radius: 24px !important;
        }
    }

    @media (max-height: 500px) and (orientation: landscape) {
        .chat-container { 
            height: 86vh !important; /* Decrease this if it's hitting the top status bar */
            width: 350px !important; 
            bottom: 4px !important;  /* Keep it low to maximize visible text area */
            right: 15px !important;
        }
    }
    
    .chat-header { padding: 0 1.5rem; background: linear-gradient(180deg, #d8b4fe 0%, #a855f7 100%); color: #ffffff; display: flex; justify-content: space-between; align-items: center; height: 55px; }
    
    /* Header Logo & Status Transparency Fix */
    .header-logo { 
        width: 35px !important; 
        height: 35px !important; 
        object-fit: contain; 
        background: transparent !important; 
        flex-shrink: 0; 
    }

    .status { 
        display: flex; 
        align-items: center; 
        gap: 0.8rem;
        max-height: 55px;
    }

    .status-indicator { width: 10px; height: 10px; background: #00ff00; border-radius: 50%; animation: blink-neon 2s infinite; box-shadow: 0 0 12px #00ff00; margin-left: 5px; }
    @keyframes blink-neon { 0%, 100% { opacity: 1; filter: brightness(1.2); } 50% { opacity: 0.4; filter: brightness(0.8); } }
    .status-text { font-family: 'Space Mono', monospace; font-size: 0.85rem; color: #ffffff; font-weight: 700; display: flex; align-items: center; }
    .close-chat { cursor: pointer; font-size: 1.2rem; color: white; transition: 0.2s; }
    .close-chat:hover { transform: rotate(90deg); }

    .quick-actions { padding: 1rem; display: flex; gap: 0.6rem; flex-wrap: wrap; background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .quick-btn { padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.85); border: none; border-radius: 20px; color: #000; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
    
    .messages { flex: 1; padding: 2rem; overflow-y: auto; color: white; }
    .input-area { padding: 20px; background: rgba(255, 255, 255, 0.05); }
    .input-wrapper { display: flex; gap: 12px; background: white; padding: 8px 15px; border-radius: 30px; align-items: center; }
    #messageInput { flex: 1; border: none; outline: none; font-size: 1rem; padding: 8px; color: #333 !important; }
    #sendButton { background: var(--primary-dark); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

/* SURGICAL FIX: Landscape Optimization for Text and Buttons */
@media (max-height: 500px) and (orientation: landscape) {
    /* Shrink the Welcome Greeting */
    .chat-container h2 { 
        font-size: 1.1rem !important; 
        margin: 5px 0 !important; 
    }
    .chat-container p { 
        font-size: 0.85rem !important; 
        line-height: 1.2 !important; 
        margin-bottom: 8px !important;
    }

    /* Shrink Quick Action Buttons */
    .quick-actions {
        padding: 0.5rem !important;
        gap: 0.4rem !important;
    }
    .quick-btn {
        padding: 0.3rem 0.7rem !important;
        font-size: 0.75rem !important;
        border-radius: 12px !important;
    }

    /* Reduce message area padding to save vertical space */
    .messages { 
        padding: 1rem !important; 
    }

    /* Shrink the input area slightly */
    .input-area {
        padding: 10px 15px !important;
    }
    .input-wrapper {
        padding: 4px 12px !important;
    }
    }
    /* SURGICAL FIX: Force Safari dropdowns to match standard inputs */
    select {
        -webkit-appearance: none; /* Removes Safari default styling */
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center; /* Places the arrow icon */
        background-size: 12px;
        padding-right: 30px !important; /* Makes room for the new arrow */
        height: 52px !important; /* Force exact height match with inputs */
        line-height: normal !important;
    }

    /* Fix for iOS/Safari specific inner shadow */
    select:focus, input:focus {
        outline: none;
        box-shadow: none !important;
    }

/* Styling the links inside Eggy's responses. Standard State: Purple, Bold, No Underscore  */
/* --- 1. REGULAR TEXT LINKS (STAYS PURPLE, TURNS RED ON HOVER) --- */
/* We use :not() to make sure these rules DON'T touch our buttons */
.message a:not(.eggy-btn-alt):not([href*="pdf"]), 
.assistant a:not(.eggy-btn-alt):not([href*="pdf"]) {
    color: #d8b4fe !important; 
    text-decoration: none !important;
    font-weight: bold !important;
    padding: 2px 4px;
    background-color: rgba(216, 180, 254, 0.1);
    border-radius: 4px;
    transition: all 0.2s ease;
}

.message a:not(.eggy-btn-alt):not([href*="pdf"]):hover, 
.assistant a:not(.eggy-btn-alt):not([href*="pdf"]):hover {
    color: #FFFFFF !important;
    background-color: var(--ks-red) !important; 
    transform: translateY(-1px);
}

/* --- 2. THE SKILLJAR-STYLE BUTTONS (PURPLE BORDER BOX) --- */
/* Used for Asset Library A/B, Skilljar, and Browser Review */
/* Unifying both classes to look EXACTLY the same */
.eggy-btn, .eggy-btn-alt {
    display: inline-block !important;
    width: fit-content !important;
    padding: 10px 18px !important;
    margin: 12px 0 !important; /* Unified margin for consistent gaps */
    border-radius: 8px !important;
    text-decoration: none !important;
    font-weight: bold !important;
    background: rgba(168, 85, 247, 0.2) !important; /* Unified Purple Tint */
    color: #d8b4fe !important; /* Unified High-Vis Purple */
    border: 1.5px solid #a855f7 !important; /* Unified Border Color */
    transition: all 0.3s ease !important;
    box-sizing: border-box !important;
}

.eggy-btn:hover, .eggy-btn-alt:hover {
    background: rgba(168, 85, 247, 0.6) !important;
    color: #ffffff !important;
    transform: translateY(-2px) !important;
}

/* --- 3. THE RED DOWNLOAD BUTTON (STAYS KEYSIGHT RED) --- */
.assistant a[href*="DealRegistrationPlaybook.pdf"]:not(.eggy-btn-alt) {
    display: inline-block !important;
    margin-top: 10px !important;
    padding: 12px 24px !important;
    background-color: #E11A22 !important;
    color: #FFFFFF !important;
    border-radius: 6px !important;
    font-weight: bold !important;
}

/* Update this specific section in CSS. Fix for URL wrapping to prevent jiggle */
.message div {
    word-wrap: break-word;       /* Older browsers */
    overflow-wrap: break-word;   /* Modern browsers */
    word-break: break-word;      /* Forces the URL to snap to a new line */
}
      
/* Update */
.message a:hover, .assistant a[href*="DealRegistrationPlaybook.pdf"]:hover {
    color: #FFFFFF !important;
    background-color: var(--ks-red) !important; 
    text-decoration: none !important;
    transform: translateY(-1px);
    display: inline-block; /* Ensures the red box wraps correctly */
}
   
/* Fix for lists that might lose their bullets */
.assistant ul {
    margin-left: 20px;
    padding-bottom: 10px;
}

.quick-btn:active {
    transform: scale(0.95);
    background-color: var(--primary);
    color: white;
}
    
        /* Keep this: it flags the year 2025 or earlier as an error */
        #date:invalid {
            border-bottom: 2px solid #E11A22;
            color: #E11A22;
        }

        /* Keep this: subtle glow for better UX */
        #date:invalid:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(225, 26, 34, 0.3);
        }

        /* Keep this: colors the icon red and fixes the iPhone spacing */
        #date::-webkit-calendar-picker-indicator {
            filter: invert(18%) sepia(88%) saturate(7467%) hue-rotate(352deg) brightness(91%) contrast(92%);
            cursor: pointer;
            margin-right: 2px; /* Surgical Fix: gives the icon a tiny bit of breathing room from the edge */
            padding: 0;
        }

    .bot-message b {
        color: #E11A22; /* Keysight Red for the tip title */
    }

    /* Make sure the chatbot doesn't jump around when new tips arrive */
    #chatbot-messages {
        scroll-behavior: smooth;
    }

/* Style for the Currency Info Icon */
.currency-info i {
    font-size: 12px;
    cursor: help;
    transition: transform 0.2s;
}

.currency-info i:hover {
    transform: scale(1.2);
    color: var(--primary-dark); /* Turns purple on hover to match Eggy */
}

/* Ensure the label doesn't clip the icon when it floats up */
input:focus + label .currency-info, 
input:not(:placeholder-shown) + label .currency-info,
select:focus + label .currency-info, 
select:not([data-value=""]) + label .currency-info {
    display: inline-block;
}

/* --- DATA INTEGRITY ERROR PULSE --- */
.integrity-error {
    border: 1px solid var(--ks-red) !important;
    box-shadow: 0 0 10px rgba(233, 0, 41, 0.5);
    animation: integrity-pulse 1.5s infinite;
}

@keyframes integrity-pulse {
    0% { box-shadow: 0 0 0px rgba(233, 0, 41, 0.4); }
    50% { box-shadow: 0 0 15px rgba(233, 0, 41, 0.8); }
    100% { box-shadow: 0 0 0px rgba(233, 0, 41, 0.4); }
}

/* ============================================== */
/* üõ°Ô∏è SANCTIONS SCREENING STYLES                 */
/* ============================================== */

/* Scanning animation on the customer input when check is running */
@keyframes sanctions-scan {
    0%   { background-position: 200% center; }
    100% { background-position: -200% center; }
}

input.sanctions-scanning {
    background: linear-gradient(90deg, #ffffff 0%, rgba(168,85,247,0.12) 40%, rgba(168,85,247,0.22) 50%, rgba(168,85,247,0.12) 60%, #ffffff 100%);
    background-size: 200% auto;
    animation: sanctions-scan 1.4s linear infinite;
    border-color: #a855f7 !important;
}

/* The compliance badge that appears below the End Customer field */
#sanctions-status {
    display: none;
    margin-top: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.3px;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-family: 'Space Mono', monospace;
}

#sanctions-status.show { display: flex; }

#sanctions-status.checking {
    background: rgba(168, 85, 247, 0.08);
    border: 1px solid rgba(168, 85, 247, 0.35);
    color: #a855f7;
}

#sanctions-status.clear {
    background: rgba(34, 197, 94, 0.08);
    border: 1px solid rgba(34, 197, 94, 0.35);
    color: #16a34a;
}

#sanctions-status.flagged {
    background: rgba(233, 0, 41, 0.08);
    border: 1px solid rgba(233, 0, 41, 0.4);
    color: var(--ks-red);
    animation: integrity-pulse 1.5s infinite;
}

#sanctions-status.review {
    background: rgba(234, 179, 8, 0.08);
    border: 1px solid rgba(234, 179, 8, 0.5);
    color: #b45309;
}

/* The spinning radar icon for "checking" state */
@keyframes spin-radar {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}
.sanctions-spinner {
    display: inline-block;
    animation: spin-radar 0.8s linear infinite;
}

/* Pulse dot for "clear" state */
@keyframes pulse-green {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.4; }
}
.sanctions-pulse-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #22c55e;
    display: inline-block;
    flex-shrink: 0;
    animation: pulse-green 2s infinite;
}

/* Source chip ‚Äî "Powered by OpenSanctions" */
.sanctions-source {
    margin-left: auto;
    font-size: 10px;
    font-weight: 400;
    opacity: 0.6;
    font-family: 'DM Sans', sans-serif;
    letter-spacing: 0;
}

/* ============================================== */
/* END SANCTIONS STYLES                           */
/* ============================================== */

</style>
</head>
<body>

<header>
    <div class="top-bar">
        <a href="#" class="icon-circle"><i class="fas fa-bell"></i></a>
        <a href="#" class="icon-circle"><i class="fas fa-user"></i></a>
    </div>
    <nav class="navbar">
        <div class="navbar-brand"><img src="https://eggplantpartners.keysight.com/images/logos/logo.png" alt="Keysight"></div>
        <ul class="nav-navbar">
            <li>Home</li><li>Asset Library</li><li class="active">Deals</li><li>Journey</li><li>Training</li><li>Events</li><li>Insignias</li>
        </ul>
    </nav>
</header>

<section class="page-content">

    <h1>Register New Deal</h1>
    <p class="instruction-text">
        All fields in the form below are <strong style="color: var(--ks-red);">MANDATORY</strong> to ensure valid deal registration and protection.
    </p>

    <h1>Deal Information</h1>
    <p class="instruction-text">
        Please enter the information required for this deal. For a deal referral, it is mandatory to attach an invoice with the final referral fee after the closed won stage. This invoice must include the final referral fee amount, contact First and Last name, contact email, and should be uploaded in a timely manner.
    </p>

    <!-- ============================================== -->
    <!-- üÜï CHANGE #4: NEW HELP BANNER (INSERTED HERE) -->
    <!-- ============================================== -->
    <div class="eggy-help-banner">
        <p>
            <img src="assets/images/EggySmall.png" alt="Eggy" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
            <strong>Need help?</strong> Click the purple Eggy icon 
            <span class="eggy-badge">bottom right ‚Üí</span>
            to ask questions about requirements, timelines, or approval process!
        </p>
    </div>
    <!-- ============================================== -->
    <!-- END OF NEW HELP BANNER                        -->
    <!-- ============================================== -->

    <div class="form-container">
        <form id="dealForm">
            <div class="form-row">
                <div class="col-1 field-wrapper"><input type="text" id="dealName" placeholder=" " required><label>Deal Name</label></div>
                <div class="col-2 field-wrapper">
                    <input type="text" id="customer" list="customer-list" placeholder=" " required autocomplete="off">
                    <label>End Customer (Company, Country, Website)</label>
                    <datalist id="customer-list">
                        <option value="New_AwesomeCompany | Estonia | www.newawesomecompany.com">
                        <option value="Quantum Dynamics | Finland | www.quantum-dyn.fi">
                        <option value="Baltic Logistics | Latvia | www.baltic-log.lv">
                        <option value="Helsinki Systems | Finland | www.helsinkisys.com">
                        <option value="Tallinn Tech | Estonia | www.tallinntech.ee">
                    </datalist>
                    <!-- üõ°Ô∏è SANCTIONS STATUS BADGE -->
                    <div id="sanctions-status" role="status" aria-live="polite"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="col-1 field-wrapper">
                    <input type="number" id="amount" placeholder=" " required min="25000">
                    <label>Amount - min: $25k USD equiv.</label>
                </div>
                
                <div class="col-1 field-wrapper">
                    <select id="currency" required data-value="">
                        <option value="" disabled selected hidden></option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="CHF">CHF - Swiss Franc</option>
                        <option value="CNY">CNY - Chinese Yuan</option>
                        <option value="INR">INR - Indian Rupee</option>
                        <option value="SGD">SGD - Singapore Dollar</option>
                        <option value="TWD">TWD - Taiwan New Dollar</option>
                        <option value="KRW">KRW - Korea (South) Won</option>
                        <option value="MYR">MYR - Malaysian Ringgit</option>
                        <option value="MXN">MXN - Mexican Peso</option>
                        <option value="BRL">BRL - Brazilian Real</option>
                        <option value="VND">VND - Vietnamese Dong</option>
                        <option value="THB">THB - Thai Baht</option>
                        <option value="ILS">ILS - Israeli New Shekel</option>
                        <option value="HKD">HKD - Hong Kong Dollar</option>
                        <option value="DKK">DKK - Danish Krone</option>
                        <option value="SEK">SEK - Swedish Krone</option>
                    </select>
                    <label>Currency</label>
                    <span class="required">
                        <a href="https://fiscaldata.treasury.gov/currency-exchange-rates-converter/" 
                           target="_blank" 
                           title="Use U.S. Treasury official rates to verify $25k threshold"
                           style="color: var(--ks-red); text-decoration: none;">
                            <i class="fas fa-info-circle"></i>
                        </a>
                    </span>
                </div>

                <div class="col-1 field-wrapper">
                    <select id="type" required data-value="">
                        <option value="" disabled selected hidden></option>
                        <option value="Deal">Deal</option>
                        <option value="Referral">Referral</option>
                    </select>
                    <label>Type</label>
                </div>
            </div>

            <div class="form-row">
                <div class="col-1 field-wrapper">
                    <select id="stage" required data-value="">
                        <option value="" disabled selected hidden></option>
                        <option>New Deal</option><option>Prospecting</option><option>Discovery</option>
                        <option>Evaluating</option><option>Negotiation</option><option>Closed Won</option>
                        <option>Denied</option><option>Closed Lost</option>
                    </select>
                    <label>Stage</label>
                </div>

                <div class="col-1 field-wrapper">
                    <div class="prob-container">
                        <input type="number" 
                               id="prob" 
                               placeholder=" " 
                               required 
                               min="1" 
                               max="100" 
                               oninput="this.value = Math.round(this.value)">
                        <label>Probability</label>
                        <div class="suffix">%</div>
                    </div>
                </div>

        <div class="col-1 field-wrapper" style="padding-right: 15px; box-sizing: border-box;">
            <input type="date" 
                id="date" 
                placeholder=" " 
                required 
                min="2026-01-01" 
                max="2035-12-31"
                style="width: 100% !important; padding: 22px 12px 6px 12px !important;">
            <label>Close Date</label>
        </div>
        </div>
            <div class="form-row">
                <div class="col-2 field-wrapper">
                    <textarea id="briefDesc" placeholder="Please add additional details: project's overview, key decision makers, use case, key competitors and primary drivers to win the deal, new or existing end customer, etc." style="resize: vertical; min-height: 120px;" required></textarea>
                    <label>Brief Description</label>
                </div>
                <div class="col-1 field-wrapper">
                    <select id="source" required data-value="">
                        <option value="" disabled selected hidden></option>
                        <option value="Deal Registration">Deal Registration</option>
                        <option value="Referral">Referral</option>
                        <option value="Email Campaign">Email Campaign</option>
                        <option value="Partner Locator">Partner Locator</option>
                        <option value="Social Campaign">Social Campaign</option>
                        <option value="Trade Show">Trade Show</option>
                        <option value="Web Syndication">Web Syndication</option>
                    </select>
                    <label>Source</label>
                </div>
            </div>

            <div id="referral-upload-container" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" style="display:none" multiple>
                <div class="upload-content">
                    <i class="fas fa-download" style="color: #E11A22; margin-right: 8px;"></i>
                    <span class="upload-link"> Upload invoice file in pdf format</span> or drag and drop up to 10 files (Max 23.8 MB)
                </div>
            </div>
             <button type="submit" class="btn-submit">Submit</button>
 
        </form>

            <div id="success-message" style="display:none; text-align:center; padding:80px 20px;">
                <i class="fas fa-check-circle" style="color: #22c55e; font-size: 60px; filter: drop-shadow(0 0 10px rgba(34, 197, 94, 0.4));"></i>
                <h2 style="font-size: 28px; margin-top:20px;">Congratulations!</h2>
                <p style="font-size: 18px; color: #555;">The deal registration request has been submitted successfully.</p>
             <p>Your Keysight Regional Partner Account Manager will review the request within <strong>two business days</strong>.</p>
            </div>
   
    </div>
</section>

<!-- ============================================== -->
<!-- üÜï CHANGE #5: NEW TOOLTIP (INSERTED HERE)    -->
<!-- ============================================== -->
<div id="eggy-tooltip" onclick="toggleChat(); this.style.display='none';">
    <span>Try Eggy! AI Deal Assistant ‚Üí</span>
</div>
<!-- ============================================== -->
<!-- END OF NEW TOOLTIP                            -->
<!-- ============================================== -->

<div id="chatbot-launcher" onclick="toggleChat()">
    <div class="notif-badge" id="chat-notif">1</div>
    <img src="assets/images/EggySmall.png" alt="Eggy" id="eggy-img">
</div>

<div class="chat-container" id="chatbot-window">
    <div class="chat-header">
        <div class="status">
            <img src="assets/images/EggySmall.png" alt="Eggy" class="header-logo">
            <span class="status-text">Eggy is Online <div class="status-indicator"></div></span>
        </div>
        <div class="close-chat" onclick="toggleChat()"><i class="fas fa-times"></i></div>
    </div>

    <div class="quick-actions">
        <button class="quick-btn">New Deal Help</button>
        <button class="quick-btn">Requirements</button>
        <button class="quick-btn">Extensions</button>
        <button class="quick-btn">Deal Reg Guide</button>
    </div>

    <div class="messages" id="messages">
        <div class="welcome-message">
            <h2>Hi! I'm Eggy!</h2>
            <p>Your AI assistant for seamless deal registration on the Keysight Eggplant Partner Portal.</p>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="messageInput" placeholder="How can I help you today?">
            <button id="sendButton">SEND</button>
        </div>
    </div>

</div>

<footer>
    <div class="footer-left">
        <strong>Contact Us</strong>
        <p>1400 Fountaingrove Parkway</p>
        <p>Santa Rosa, CA 95403-1738</p>
        <p>United States</p>
        <p>+1 800-829-4444</p>
        <p><a href='#' class="">[email&#160;protected]</a></p>
        <br>
        <p>¬© Keysight Technologies 2024</p>
    </div>
    <div class="footer-right">
        <strong>FOLLOW US</strong>
        <div class="social-links">
            <a href="https://www.linkedin.com/company/keysight-technologies" target="_blank"><i class="fab fa-linkedin"></i></a>
            <a href="https://x.com/Keysight" target="_blank">‚Äå<i class="fa-brands fa-x-twitter">‚Äå</i></a>
            <a href="https://www.facebook.com/Keysight" target="_blank"><i class="fab fa-facebook"></i></a>
            <a href="https://www.youtube.com/user/keysight" target="_blank"><i class="fab fa-youtube"></i></a>
            <a href="#"><i class="fab fa-weixin"></i></a>
        </div>
    </div>
</footer>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    /* --- PART 1: DEAL REGISTRATION PAGE LOGIC (No Changes) --- */
    const typeSelect = document.getElementById('type');
    const uploadBox = document.getElementById('referral-upload-container');
    const allSelects = document.querySelectorAll('select');
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            if (this.value === 'Referral') { uploadBox.classList.add('show'); } 
            else { uploadBox.classList.remove('show'); }
        });
    }
    allSelects.forEach(s => {
        s.addEventListener('change', function() { this.setAttribute('data-value', this.value); });
    });

    /* --- PART 2: CHATBOT UI & STATE --- */
    let chatOpened = false;
    function toggleChat() {
        const chat = document.getElementById('chatbot-window');
        const notif = document.getElementById('chat-notif');
        const eggy = document.getElementById('eggy-img');
        chatOpened = true;
        if (chat) chat.style.display = (chat.style.display === 'flex') ? 'none' : 'flex';
        if (notif) notif.style.display = 'none';
        if (eggy) eggy.classList.remove('wave-animate');
    }

    /* --- PART 3: CHATBOT MESSAGING LOGIC --- */
    function addMessage(content, isUser) {
        const messagesContainer = document.getElementById('messages');
        if (!messagesContainer) return;
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        if (welcomeMessage) welcomeMessage.remove();
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
        const avatarContent = isUser ? '<i class="fas fa-user"></i>' : '<img src="assets/images/EggySmall.png" alt="Eggy" style="width:30px;">';
        const author = isUser ? 'You' : 'Eggy';
        messageDiv.style.marginBottom = "15px";
        messageDiv.style.display = "flex";
        messageDiv.style.flexDirection = "column";
        messageDiv.style.alignItems = isUser ? "flex-end" : "flex-start";
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; opacity: 0.8; font-size: 0.75rem; font-family: 'Space Mono', monospace;">
                ${!isUser ? avatarContent : ''} <span>${author} ‚Ä¢ ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span> ${isUser ? avatarContent : ''}
            </div>
            <div style="background: ${isUser ? 'rgba(216, 180, 254, 0.2)' : 'rgba(255, 255, 255, 0.1)'}; 
                        padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; 
                        border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); color: white;">
                ${!isUser ? marked.parse(content) : content}
            </div>
        `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

        /* --- EMERGENCY MODULE: SMART PRE-BUILT RESPONSES --- */
        async function getAIResponse(userMessage) {
        // Increased to 1.5 seconds for a more "analytical" feel
        await new Promise(resolve => setTimeout(resolve, 1200));

        const input = userMessage.toLowerCase();
        
        // 1. Playbook & Rules (High Priority)
        if (input.includes("rule") || input.includes("playbook") || input.includes("guide")) {
            return "As the Program Manager who architected the **Deal Registration Playbook**, I've ensured our rules are built for partner success: \n\n" +
                "* **Threshold:** Minimum deal size is **$25,000 USD** equivalent.\n" +
                "* **Timing:** Register at least **14 days** before the expected close.\n" +
                "* **Exclusions:** Renewals and RFPs are not eligible for registration protection.\n\n" +
                "Would you like to **preview the strategy** now, or save it for later?\n\n" +
              // üìÑ Review in Browser Button
                "<a href='assets/DealRegistrationPlaybook.pdf' target='_blank' class='eggy-btn-alt'>üìÑ Review in Browser</a>\n\n" +
                "You can download it below:\n\n" +
                "<a href='assets/DealRegistrationPlaybook.pdf' download='DealRegistrationPlaybook.pdf' target='_blank' " +
                "style='display: inline-block; padding: 12px 24px; background-color: #E11A22; color: white; " +
                "text-decoration: none; border-radius: 6px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);'>" +
                "<i class='fas fa-download' style='margin-right: 8px;'></i> Download PDF Playbook</a>";  
        }

        // 2. Threshold
        if (input.includes("limit") || input.includes("amount") || input.includes("25") || input.includes("money")) {
            return "The **$25,000 USD threshold** is a hard rule from our Playbook. Use the currency dropdown in the form to check the real-time conversion. If the deal is smaller, it won't qualify for registration benefits.";
        }
        // 3. Currency
        if (input.includes("currency") || input.includes("convert") || input.includes("euro") || input.includes("gbp")) {
            return "üåç **Global Deal?** Since we require a **$25,000 USD minimum**, I recommend using the **U.S. Treasury's Official Converter** to ensure accuracy: \n\n" +
           "<a href='https://fiscaldata.treasury.gov/currency-exchange-rates-converter/' target='_blank' class='eggy-btn-alt'>üè¶ Open Treasury Converter</a>";
        }       

        // 4. Extensions (Quick Action Support)
        if (input.includes("extension") || input.includes("expire") || input.includes("long") || input.includes("90") || input.includes("midpoint") || input.includes("check")) {
            return "Deals are protected for **180 days**. However, the **90-day midpoint check** is mandatory: you must conduct a customer evaluation and demonstrate progress to keep protection active. Failing to show progress leads to the deal being 'unregistered'.";
        }

        // 5. Requirements & Steps
        if (input.includes("requirement") || input.includes("need") || input.includes("step")) {
            return "To successfully register, you need: \n1. **End Customer details** (Legal name & Website).\n2. **Project overview** and key drivers to win.\n3. **Technical discovery** confirmation.\n\nI'll check these as you fill out the form!";
        }

        // 6. Help with New Deal (Quick Action Support)
        if (input.includes("new deal") || input.includes("new") || input.includes("deal") || input.includes("start")) {
            return "I'm ready! Start by entering the **Deal Name** and selecting the **End Customer**. I recommend using a descriptive name like 'Project Quantum - Eggplant AI Enablement'.";
        }

        // 7. Rejection & Termination (new logic)
        if (input.includes("reject") || input.includes("denied") || input.includes("lose") || input.includes("remove")) {
            return "üßê **Why deals get rejected:**\n\n" +
                "* **Legal:** Keysight may be obligated to bid directly.\n" +
                "* **Inattentiveness:** Not actively working the deal.\n" +
                "* **First-Come:** Another partner was faster.\n" +
                "* **Competing:** Offering other products for the same deal.";
        }

        // 8. Referral vs Deal Registration
        if (input.includes("referral") || input.includes("refer") || input.includes("hand-off")) {
            return "As part of the **Eggplant AI Enablement** strategy, we distinguish between two paths:\n\n" +
                "* **Deal Registration:** You lead the sales cycle. Requires a **$25k minimum**.\n" +
                "* **Referral:** You identify the opportunity and 'hand-off' to our team. You can track progress via the **'Deal Stage'** dropdown in the portal.\n\n" +
                "**Mandatory Invoice:** If the deal reaches **'Closed Won'**, you must upload a PDF invoice including the company name, closing date, fee amount, and authorizing contact.\n\n" +
                "**Note on Fees:** Specific amounts are outlined in your individual **Partner Sales Agreement (PSA)** rather than the Playbook, as they are tier-dependent.";
        }

        // 9. New Section Government/Bids
        if (input.includes("government") || input.includes("bid") || input.includes("rfp")) {
            return "For **Open Bids/Government contracts**: \n\n" +
                "* **RFPs:** Standard deal registration is not eligible.\n" +
                "* **Bids:** A non-registered discount may be given to all resellers, but the full protected discount is awarded to the partner who **wins the contract award**.";
        }

        // 10. New Section Presales Effort
        if (input.includes("effort") || input.includes("proof") || input.includes("work")) {
            return "To qualify for protection, you must document **significant presales efforts**, such as: \n\n" +
                "* Meeting with decision-makers.\n" +
                "* Quantifying project budgets.\n" +
                "* Qualifying technical requirements.\n\n" +
                "Keysight may audit these records at any time to verify compliance.";
        }

        // 11. Confirmation & Post-Submission Support
        if (input.includes("notification") || input.includes("after") || input.includes("next steps") || input.includes("wait")) {
            return "Once submitted, here is the timeline:\n\n" +
                "* **Response:** You will receive an email notification within **two business days** (Accepted or Declined).\n" +
                "* **Support Team:** If accepted, Keysight assigns a **dedicated Sales Executive and Solution Architect** to help your team close the deal.\n\n" +
                "This ensures you have full technical and commercial alignment to win!";
        }

        // 12. Audits & Ethical Conduct
            if (input.includes("audit") || input.includes("compliance") || input.includes("integrity") || input.includes("violation") || input.includes("rules")) {
                return "Keysight maintains program integrity through strict compliance rules:\n\n" +
                    "* **Audits:** Keysight may audit deals at any time to verify any documents or info submitted.\n" +
                    "* **Denial/Removal:** Registrations can be rescinded if a partner is inattentive, offers competitive products, or provides inaccurate/fraudulent info.\n" +
                    "* **Non-Disclosure:** Partners must **not** discuss Deal Registration details with customers or use them to influence choice between partners.\n" +
                    "* **Final Authority:** Keysight's interpretation of these guidelines is non-negotiable and final.";
            }

        // 13. Eggy's Greetings
        if (input.includes("hello") || input.includes("hi") || input.includes("eggy") || input.includes("hey")) {
            return "Hi! I'm **Eggy**. I helped design the Keysight Eggplant partner rules. I'm here to make sure your deal registration is perfect so it gets approved fast!";
        }

        // Default "Smart" Fallback
        return "That's a good question. While I'm in 'Demo Mode', I'm focused on the **Deal Registration Playbook** rules. Try asking me about 'Requirements', 'Extensions', or the '$25k Threshold'!";
    }   
    
        async function sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input || !input.value.trim()) return;
        const message = input.value.trim();
        input.disabled = true;
        addMessage(message, true);
        input.value = '';

        // Add "typing" placeholder
        const messagesContainer = document.getElementById('messages');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `<div style="color:rgba(255,255,255,0.5); font-size:0.8rem; margin-bottom:15px; padding-left:10px;">Eggy is thinking...</div>`;
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const response = await getAIResponse(message);
        
        // Remove typing indicator and show response
        document.getElementById('typing-indicator').remove();
        addMessage(response, false);
        input.disabled = false;
        input.focus();
    }

    /* --- PART 4: EVENT LISTENERS --- */
    document.addEventListener('DOMContentLoaded', () => {
        // FIXED QUICK BUTTONS LOGIC
        document.querySelectorAll('.quick-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const query = btn.innerText;
                const input = document.getElementById('messageInput');
                
                // Put the text in the input and trigger the existing sendMessage function
                input.value = query;
                sendMessage();
            });
        });
    
        const msgInput = document.getElementById('messageInput');
        if (msgInput) msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
        
        const sendBtn = document.getElementById('sendButton');
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    
        /* ============================================== */
        /* üÜï CHANGE #6: AUTO-OPEN CHATBOT AFTER 4 SEC  */
        /* ============================================== */
        setTimeout(() => {
            if (!chatOpened) {
                // Auto-hide tooltip after 10 seconds
                const tooltip = document.getElementById('eggy-tooltip');
                if (tooltip) tooltip.style.display = 'none';
                
                // üÜï AUTO-OPEN THE CHAT (instead of just showing notification)
                toggleChat();
                addMessage("Hi! I'm Eggy, your AI deal assistant. I can help with requirements, timelines, and approval questions. What would you like to know?", false);
            }
        }, 4000); // üÜï Changed from 5000 to 4000 (4 seconds)
        /* ============================================== */
        /* END OF AUTO-OPEN CHANGE                       */
        /* ============================================== */
    });
        

    /* --- PART 5: AGENTIC FIELD OBSERVER --- */
    document.addEventListener('DOMContentLoaded', () => {
        // Map your Form Field IDs to the specific keyword in your getAIResponse logic
        const fieldTips = {
            'deal-name': 'new deal',
            'customer-name': 'requirement',
            'deal-amount': 'limit',
            'deal-type': 'referral',
            'closing-date': 'extension'
        };

        // Attach listeners to each field
        Object.keys(fieldTips).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('focus', async () => {
                    // Only trigger if the chatbot container is open (active)
                    const chatbotContainer = document.getElementById('chatbot-container');
                    if (chatbotContainer.classList.contains('active')) {
                        
                        const triggerKeyword = fieldTips[fieldId];
                        const tipResponse = await getAIResponse(triggerKeyword);
                        
                        // Add a special 'agent-tip' class so it looks different from a regular chat
                        addMessage("<b>Eggy's Pro-Tip:</b> " + tipResponse, 'bot');
                    }
                });
            }
        });
    });

/* --- PART 6: ACTIVE GOVERNANCE (SOX & 21-Currency Global Anchor) --- */
document.querySelectorAll('input, select').forEach(field => {
    field.addEventListener('blur', async (e) => {
        const value = e.target.value;
        const fieldId = e.target.id;
        const el = e.target;
        const chatWindow = document.getElementById('chatbot-window');
        let alertMessage = "";
        
        // 1. Threshold & Global Currency Logic
        if (fieldId === 'amount' || fieldId === 'currency') {
            const amtEl = document.getElementById('amount');
            const curEl = document.getElementById('currency');
            const amtVal = amtEl.value;
            const curVal = curEl.value;

            if (amtVal !== "" && curVal !== "") {
                // Shield: Block scientific notation (the "E" bug)
                if (amtVal.toLowerCase().includes('e')) {
                    amtEl.classList.add('integrity-error');
                    alertMessage = "üö´ **Format Error:** Scientific notation (e) is not permitted. Please enter a standard number.";
                    amtEl.value = "";
                } else {
                    // FULL DEMO RATE TABLE (USD Base)
                    const rates = {
                        "USD": 1.0, "EUR": 1.08, "GBP": 1.27, "JPY": 0.0066, 
                        "AUD": 0.65, "CAD": 0.74, "CHF": 1.14, "CNY": 0.14,
                        "INR": 0.012, "SGD": 0.74, "TWD": 0.031, "KRW": 0.00075,
                        "MYR": 0.21, "MXN": 0.058, "BRL": 0.20, "VND": 0.000041,
                        "THB": 0.028, "ILS": 0.27, "HKD": 0.13, "DKK": 0.15, "SEK": 0.096
                    };

                    const rate = rates[curVal] || 1.0; 
                    const usdEquiv = parseFloat(amtVal) * rate;

                    if (usdEquiv < 25000) {
                        amtEl.classList.add('integrity-error');
                        // Precision verbiage for the partner
                        alertMessage = `üí∞ **Minimum Threshold:** $${parseFloat(amtVal).toLocaleString()} ${curVal} is approximately **$${Math.round(usdEquiv).toLocaleString()} USD**. \n\nThis is below the mandatory **$25k USD minimum** required for deal protection.`;
                    } else {
                        amtEl.classList.remove('integrity-error');
                    }
                }
            }
        } 
        
        // 2. Precision Date Validation (SOX & 14-Day Rule)
        else if (fieldId === 'date' && value !== "") {
            const inputDate = new Date(value);
            const today = new Date();
            today.setHours(0,0,0,0);
            const daysToClose = Math.ceil((inputDate - today) / (1000 * 60 * 60 * 24));

            if (inputDate < today) {
                el.classList.add('integrity-error');
                alertMessage = `üö´ **Data Integrity Alert (SOX):** Back-dating is not permitted for compliance reasons.`;
                el.value = ''; 
            } else if (daysToClose < 14) {
                el.classList.add('integrity-error'); 
                alertMessage = `‚è∞ **Process Note:** This date is valid, but since it's only **${daysToClose} days** away, we need PAM approval to expedite.`;
            } else {
                el.classList.remove('integrity-error');
            }
        }

        // --- EXECUTION: Trigger Eggy ---
        if (alertMessage) {
            chatWindow.style.display = 'flex';
            addMessage(alertMessage, false);
            updateSubmitState(true);
            const eggyImg = document.getElementById('eggy-img');
            if (eggyImg) eggyImg.classList.add('wave-animate');
        } else {
            const remainingErrors = document.querySelectorAll('.integrity-error').length;
            if (remainingErrors === 0) updateSubmitState(false);
        }
    });
});

/* --- PART 6.1: DATA INTEGRITY (Linguistic Gate) --- */
document.addEventListener('DOMContentLoaded', () => {
    const textFields = [
        { id: 'dealName', label: 'Deal Name' },
        { id: 'customer', label: 'End Customer' }
    ];
    const latinRegex = /^[a-zA-Z0-9\s.,&#\-\/\(\)|]+$/;

    textFields.forEach(field => {
        const el = document.getElementById(field.id);
        if (!el) return;

        // 1. BLUR: Validates when they LEAVE the field
        el.addEventListener('blur', (e) => {
            let val = e.target.value.trim();
            if (!val) return;

            if (!latinRegex.test(val)) {
                el.classList.add('integrity-error');
                const chatWindow = document.getElementById('chatbot-window');
                chatWindow.style.display = 'flex'; 

        const keyboardMessage = `üåç **Global Match:** I noticed the **${field.label}** uses local characters.\n\n` +
                    `To ensure our global systems sync correctly, please use Latin/English. If you don't have a Latin keyboard active, you can use this tool:\n\n` +
                    `<a href="https://www.google.com/inputtools/try/" target="_blank" class="eggy-btn-alt">` +
                    `<i class="fas fa-keyboard"></i> Open Global Keyboard</a>\n\n` +
                    `Or, click below to let me optimize it for you:\n\n` +
                    `<button class="eggy-btn-alt" onclick="runDemoTranslation('${field.id}')">‚ú® Auto-Optimize</button>`;

                addMessage(keyboardMessage, false);
                updateSubmitState(true);
            } else {
                // Formatting Path
                el.classList.remove('integrity-error');
                e.target.value = val.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                // Final Check to see if we can unlock the button
                const remainingErrors = document.querySelectorAll('.integrity-error').length;
                if (remainingErrors === 0) updateSubmitState(false);
            }
        }); // <-- Close Blur here

        // 2. FOCUS: Reactive wave when they click BACK in
        el.addEventListener('focus', () => {
            if (el.classList.contains('integrity-error')) {
                const eggyImg = document.getElementById('eggy-img');
                if (eggyImg) eggyImg.classList.add('wave-animate');
            }
        }); // <-- Close Focus here
    }); // <-- Close forEach here
});

/* --- THE RECOVERY ENGINE --- */

function runDemoTranslation(fieldId) {
const el = document.getElementById(fieldId);
if (!el) return;
// Demo Mapping
const translations = { "„Ç≠„Éº„Çµ„Ç§„Éà": "Keysight Technologies" };
const newValue = translations[el.value] || "Project Quantum";
el.value = newValue;
el.classList.remove('integrity-error');
addMessage(`‚úÖ **Field Optimized:** I've updated it to **"${newValue}"**. Global match confirmed!`, false);

}

/* --- PART 7: STAGE-BASED SALES ENABLEMENT --- */
const stageSelect = document.getElementById('stage');

if (stageSelect) {
    stageSelect.addEventListener('change', async function() {
        const stage = this.value;
        const chatWindow = document.getElementById('chatbot-window');
        let eggyResponse = "";

        switch(stage) {
            case "New Deal":
                eggyResponse = "üåü **Welcome!** I'm Eggy, your AI deal assistant‚Äîbuilt by **Masha Harness**, a Senior Enablement Architect who specializes in:\n\n" +
                            "‚ú® Bridging technical expertise and revenue outcomes\n" +
                            "ü§ñ Automating partner governance to save Channel Managers hours\n" +
                            "üìä Scaling ecosystems through data-driven AI\n\n" +
                            "Let's get this deal registered! Need help with requirements?";
                break;

            case "Prospecting":
                eggyResponse = "üöÄ **Ready to Pitch?** To move this lead to Discovery, we need to bridge the 'certification-to-revenue' gap. I‚Äôve architected a Sales Readiness path to get you there. \n\n" +
                               "I used SQL to build interactive dashboards in the Impartner PRM to track your journey. Start by completing the internal pre-sales onboarding below: \n\n" +
                               "<a href='#' class='eggy-btn-alt'>üìë Access Presales Training</a>"; // Use -alt here
                break;

            case "Discovery":
                eggyResponse = "üéñÔ∏è **Technical Mastery:** Strong discovery starts with certified expertise. \n\n" +
                            "I engineered a real-time API sync between **Keysight Education Services** and this dashboard. Complete your technical milestones here to unlock full deal support: \n\n" +           
                            "<a href='https://customertraining.keysight.com/page/eggplant-elearning' target='_blank' class='eggy-btn-alt'>üéì Open Skilljar LMS</a>";
                break;
                
            case "Evaluating":
                eggyResponse = "üîç **Technical Deep Dive!** To provide the right assets, which sector is this customer focused on? \n\n" +
                            "I‚Äôve curated these libraries to help you move from passive learning to active revenue generation: \n\n" +
                            "<a href='#' class='eggy-btn-alt'>üìÇ Asset Library A: Core Test</a> \n" +
                            "<a href='#' class='eggy-btn-alt'>üìÇ Asset Library B: AI Automation</a>";
                break;
                
            case "Negotiation":
                eggyResponse = "ü§ù **The Home Stretch!** In a production environment, I would trigger a **Battlecard** and a **60-sec Executive Pitch video** here. \n\n" +
                            "*[Demo Note: These assets are currently being localized for the 2026 Partner Launch. In the interview, I can discuss the specific 'Certification-to-Revenue' content I designed for these files.]*";
                break;

            case "Closed Won":
                eggyResponse = "üèÜ **Huge Congratulations!** Ensuring this deal is registered correctly now secures your commission protection. Great work!";
                break;

            case "Closed Lost":
                eggyResponse = "üìâ **Strategic Review:** Sorry to hear this. Please ensure you've selected a **Loss Reason** so we can improve our support for your future deals.";
                break;

            case "Denied":
                eggyResponse = "üö´ **Policy Note:** If a deal is denied, it's usually due to a pre-existing registration or a threshold violation. Check the **[Appeals Process](#)** or contact your PAM.";
                break;
        }

        if (eggyResponse) {
            chatWindow.style.display = 'flex';
            chatOpened = true;
            const notif = document.getElementById('chat-notif');
            if (notif) notif.style.display = 'none';
            addMessage(eggyResponse, false);
            const eggyImg = document.getElementById('eggy-img');
            if (eggyImg) eggyImg.classList.add('wave-animate');
        }

    });
}

/* --- PART 8: SMART CURRENCY MONITORING --- */
const currencyField = document.getElementById('currency');

if (currencyField) {
    currencyField.addEventListener('change', function() {
        const selectedCurrency = this.value;
        const chatWindow = document.getElementById('chatbot-window');
        
        // Trigger only if a currency is selected and it's NOT USD
        if (selectedCurrency !== "" && selectedCurrency !== "USD") {
            const eggyCurrencyAlert = "üåç **International Deal Detected!** \n\n" +
                `Since you are registering in **${selectedCurrency}**, please ensure the total value meets the mandatory **$25,000 USD** threshold. \n\n` +
                "I recommend verifying the current rate via the **U.S. Treasury Official Converter** to avoid registration rejection: \n\n" +
                "<a href='https://fiscaldata.treasury.gov/currency-exchange-rates-converter/' target='_blank' class='eggy-btn-alt'>üè¶ Open Treasury Converter</a>";

            // Force open Eggy to provide the tool
            chatWindow.style.display = 'flex';
            chatOpened = true;
            
            // Clear notification if it exists
            const notif = document.getElementById('chat-notif');
            if (notif) notif.style.display = 'none';

            addMessage(eggyCurrencyAlert, false);
            
            // Make Eggy wave!
            const eggyImg = document.getElementById('eggy-img');
            if (eggyImg) eggyImg.classList.add('wave-animate');
        }
    });
}

/* --- PART 9: SUBMIT BUTTON GOVERNANCE --- */
const submitBtn = document.querySelector('.btn-submit');

// We add a 'pointer-events' check or a simple flag
let hasCriticalViolation = false; 

function updateSubmitState(isViolated) {
    hasCriticalViolation = isViolated;
    if (hasCriticalViolation) {
        submitBtn.style.opacity = "0.5";
        submitBtn.style.cursor = "not-allowed";
        submitBtn.innerText = "Fix Errors First";
    } else {
        submitBtn.style.opacity = "1";
        submitBtn.style.cursor = "pointer";
        submitBtn.innerText = "Submit Registration";
    }
}

/* --- PART 10: CLOSING & FUN --- */
    document.querySelector('.btn-submit').addEventListener('click', function(e) {
        const form = this.closest('form') || document.querySelector('form');
        const successDiv = document.getElementById('success-message');

        if (form.checkValidity()) {
            e.preventDefault(); 
            
            // 1. Hide the form
            form.style.display = 'none';
            
            // 2. Hide the headers so the Congratulations message is the star of the show
            document.querySelectorAll('.page-content h1, .page-content .instruction-text').forEach(el => el.style.display = 'none');
            
            // üÜï HIDE THE HELP BANNER TOO
            const helpBanner = document.querySelector('.eggy-help-banner');
            if (helpBanner) helpBanner.style.display = 'none';
            
            // 3. Show Success Message
            successDiv.style.display = 'block';
            window.scrollTo(0, 0);

            // 4. Modern Tech Confetti with Keysight Red
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#E11A22', '#22c55e', '#6366f1', '#a855f7', '#fcd34d']
            });

            // ‚úÖ EGGY CELEBRATION ADDED HERE:
            addMessage("üèÜ **Huge Congratulations!** üéâ\n\n" +
            "Your deal has been submitted successfully. I'll keep an eye on the approval status for you!. \n\n" +
            "Your dedicated PAM will review this within 48 hours. Need to reach them sooner?", false);
            // Force Eggy to wave!
            const eggyImg = document.getElementById('eggy-img');
            if (eggyImg) eggyImg.classList.add('wave-animate');
        }
    });

    /* ================================================================== */
    /* üõ°Ô∏è PART 11: WORLDWIDE SANCTIONS SCREENING                         */
    /* Demo uses local blacklist. Swap checkSanctions() for real API:     */
    /*   GET https://api.opensanctions.org/search/default?q=NAME          */
    /*   Free tier: 100 req/day, no credit card required                  */
    /* ================================================================== */

    (function() {

        const DEBOUNCE_MS    = 900;
        const MIN_CHARS      = 4;
        const DEMO_BLACKLIST = [
            "rosneft", "iran electronics", "tehran", "pyongyang",
            "north korea", "sberbank", "gazprom", "wagner group"
        ];

        const customerInput   = document.getElementById('customer');
        const statusDiv       = document.getElementById('sanctions-status');
        let   debounceTimer   = null;
        let   lastChecked     = '';
        let   hasSanctionsHit = false;

        function setStatus(state, html) {
            statusDiv.className = 'show ' + state;
            statusDiv.innerHTML = html;
        }

        function clearStatus() {
            statusDiv.className = '';
            statusDiv.innerHTML = '';
            hasSanctionsHit = false;
            updateSubmitState(false);
        }

        function getCompanyName(rawValue) {
            return rawValue.split('|')[0].trim();
        }

        async function checkSanctions(companyName) {
            const name = companyName.toLowerCase();
            await new Promise(r => setTimeout(r, 700 + Math.random() * 500));
            for (const keyword of DEMO_BLACKLIST) {
                if (name.includes(keyword)) {
                    return {
                        hit: true, score: 0.97,
                        list: 'OFAC SDN / EU Consolidated',
                        url: 'https://www.opensanctions.org/search/?q=' + encodeURIComponent(companyName)
                    };
                }
            }
            return { hit: false };
        }

        async function runScreening(rawValue) {
            const companyName = getCompanyName(rawValue);
            if (companyName.length < MIN_CHARS) { clearStatus(); return; }
            if (companyName === lastChecked)    { return; }
            lastChecked = companyName;

            customerInput.classList.add('sanctions-scanning');
            setStatus('checking',
                '<span class="sanctions-spinner">‚öôÔ∏è</span> ' +
                'Screening against worldwide sanctions lists (OFAC, EU, UN, BIS)‚Ä¶' +
                '<span class="sanctions-source">Powered by OpenSanctions</span>'
            );

            try {
                const result = await checkSanctions(companyName);
                customerInput.classList.remove('sanctions-scanning');

                if (result.hit) {
                    hasSanctionsHit = true;
                    updateSubmitState(true);
                    setStatus('flagged',
                        'üö® SANCTIONS HIT ‚Äî ' + result.list + ' | Score: ' + (result.score * 100).toFixed(0) + '/100' +
                        '<span class="sanctions-source"><a href="' + result.url + '" target="_blank" style="color:inherit;">View record ‚Üó</a></span>'
                    );
                    const chatWindow = document.getElementById('chatbot-window');
                    if (chatWindow) chatWindow.style.display = 'flex';
                    const notif = document.getElementById('chat-notif');
                    if (notif) notif.style.display = 'none';
                    addMessage(
                        'üö® **SANCTIONS ALERT ‚Äî DEAL REGISTRATION BLOCKED**\n\n' +
                        '**End Customer:** ' + companyName + '\n' +
                        '**Match found on:** ' + result.list + ' (confidence: ' + (result.score * 100).toFixed(0) + '%)\n\n' +
                        'This deal cannot be submitted until Compliance clears the registration. Next steps:\n\n' +
                        '* Contact your **Regional Compliance Officer** immediately.\n' +
                        '* Do **not** communicate deal intent to the end customer until cleared.\n' +
                        '* Screening record has been **logged** with timestamp for audit trail.\n\n' +
                        '<a href="' + result.url + '" target="_blank" class="eggy-btn-alt">üîç View Sanctions Record</a>',
                        false
                    );
                    const eggyImg = document.getElementById('eggy-img');
                    if (eggyImg) eggyImg.classList.add('wave-animate');

                } else {
                    hasSanctionsHit = false;
                    updateSubmitState(false);
                    setStatus('clear',
                        '<span class="sanctions-pulse-dot"></span>' +
                        'No sanctions match found ‚Äî cleared to proceed' +
                        '<span class="sanctions-source">Powered by OpenSanctions</span>'
                    );
                }
            } catch (err) {
                customerInput.classList.remove('sanctions-scanning');
                setStatus('review',
                    '‚ö†Ô∏è Screening service unavailable ‚Äî compliance review required before approval' +
                    '<span class="sanctions-source">OpenSanctions</span>'
                );
            }
        }

        if (customerInput) {
            customerInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const val = this.value.trim();
                if (val.length < MIN_CHARS) { clearStatus(); return; }
                debounceTimer = setTimeout(() => runScreening(val), DEBOUNCE_MS);
            });
            customerInput.addEventListener('change', function() {
                clearTimeout(debounceTimer);
                const val = this.value.trim();
                if (val.length >= MIN_CHARS) runScreening(val);
            });
            customerInput.addEventListener('blur', function() {
                if (!this.value.trim()) clearStatus();
            });
        }

        // Block submit if sanctions hit
        const submitBtn = document.querySelector('.btn-submit');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                if (hasSanctionsHit) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    addMessage('üö´ **Submission blocked.** This deal is flagged on a worldwide sanctions list. Please contact Compliance before proceeding.', false);
                    return false;
                }
            }, true);
        }

    })();

</script>

</body>
</html>
